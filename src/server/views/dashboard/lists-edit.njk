{% extends "./dashboard.njk" %}

{% block dashboard %}
  <h1 class="govuk-heading-l">
    {% if listId === 'new' %}
      Create new list
    {% else %}
      Editing list {{ listId }}
    {% endif %}
  </h1>
  <h4 class="govuk-heading-s">{{ user.email }}</h4>

  {% if listCreated %}
    {{ dashboardMacros.successBanner("List created successfully") }}
  {% endif %}

  {% if listUpdated %}
    {{ dashboardMacros.successBanner("List updated successfully") }}
  {% endif %}

  {% if error.field %}
    {{ dashboardMacros.errorBanner(error) }}
  {% endif %}

  <form class="form" action="{{ req.originalUrl.replace('listUpdated=true', '') }}" method="post" required>
    <input type="hidden" name="_csrf" value="{{ csrfToken }}" />
    <div class="govuk-form-group {{ "govuk-form-group--error" if error.field === 'serviceType' }}">
      <fieldset class="govuk-fieldset">
        <legend class="govuk-fieldset__legend govuk-fieldset__legend--m">
          <h3 class="govuk-fieldset__heading govuk-heading-m">
            Service Type?
          </h3>
        </legend>
        {% if error.field === 'serviceType' %}
          <span class="govuk-error-message">
            <span class="govuk-visually-hidden">Error:</span> {{ error.text }}
          </span>
        {% endif %}
        <div class="govuk-radios">
          {% for prop, serviceType in ServiceType %}
            <div class="govuk-radios__item">
              <input
                class="govuk-radios__input"
                id="serviceType-{{ serviceType }}"
                name="serviceType"
                type="radio"
                value="{{ serviceType }}"
                {{-" checked" if list.type === serviceType }}
                {{-" disabled" if listId !== 'new' }}
              >
              <label class="govuk-label govuk-radios__label" for="serviceType">
                {{ _.startCase(serviceType) }}
              </label>
            </div>
          {% endfor %}
        </div>
      </fieldset>
    </div>

    <div class="govuk-form-group {{ "govuk-form-group--error" if error.field === 'country' }}">
      <h3 class="govuk-label-wrapper">
        <label class="govuk-label govuk-label--m" for="country-autocomplete">
          Which country is this list for?
        </label>
      </h3>
      {% if error.field === 'country' %}
        <span class="govuk-error-message">
          <span class="govuk-visually-hidden">Error:</span> {{ error.text }}
        </span>
      {% endif %}

      {% if listId !== 'new' %}
        <input class="govuk-input" name="country" type="text" value="{{list.country.name}}" disabled>
      {% else %}
        <select id="country-autocomplete" name="country" className="govuk-input--error">
          <option value=""></option>
          {% for country in countriesList %}
            <option value="{{ country.value }}" {{-" selected='selected'" if list.country.name === country.value}}>{{ country.text }}</option>
          {% endfor %}
        </select>
      {% endif %}
    </div>

    <hr />

    <div class="govuk-form-group {{ "govuk-form-group--error" if error.field === 'publishers' }}">
      <fieldset class="govuk-fieldset">
        <h3 class="govuk-label-wrapper">
          <label class="govuk-label govuk-label--m" for="publishers">
            Users
          </label>
        </h3>
        {% if error.field === 'publishers' %}
          <span class="govuk-error-message">
            <span class="govuk-visually-hidden">Error:</span> {{ error.text }}
          </span>
        {% endif %}
        <div id="publishers-hint" class="govuk-body">
          All users can accept and publish service providers on the funeral directors list in {{list.country.name}}.
        </div>
        <label class="govuk-label" for="publishers">
          Enter an email address
        </label>
        <input class="govuk-input" id="publishers" name="publishers" type="email" aria-describedby="publishers-hint">
      </fieldset>
    </div>

    <button class="govuk-button" data-module="govuk-button">
      {% if listId === 'new' %}
        Create
      {% else %}
        Add to list
      {% endif %}
    </button>

    <dl class="govuk-summary-list">
      {% for publishers in list.jsonData.publishers %}
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key">
            {{ publishers }}
          </dt>
          <dd class="govuk-summary-list__actions">
            <a class="govuk-link" href="#">
              Remove<span class="govuk-visually-hidden"> publishers</span>
            </a>
          </dd>
        </div>
      {% endfor %}
    </dl>
  </form>

  <script nonce="{{cspNonce}}">
    accessibleAutocomplete.enhanceSelectElement({
      defaultValue: '{{list.country.name}}',
      selectElement: document.querySelector('#country-autocomplete'),
      autoselect: true,
      confirmOnBlur: true
    })
  </script>
{% endblock %}
