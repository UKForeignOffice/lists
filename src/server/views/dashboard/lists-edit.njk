{% extends "./dashboard.njk" %}

{% block dashboard %}
  <h1 class="govuk-heading-l">
    {% if listId === 'new' %}
      Create new list
    {% else %}
      Editing list {{ listId }}
    {% endif %}
  </h1>
  <h4 class="govuk-heading-s">{{ user.email }}</h4>

  {% if publiser.change %}
    {{ dashboardMacros.successBanner("Success", publiser.message) }}
  {% endif %}

  {% if error.field %}
    {{ dashboardMacros.errorBanner(error) }}
  {% endif %}

  <form class="form" id="addPublisher" action="{{ req.originalUrl.replace('listUpdated=true', '') }}" method="post" required></form>
  <form class="form" id="removePublisher" action="{{ req.originalUrl.replace('listUpdated=true', '') }}" method="post" required></form>

  <input type="hidden" name="_csrf" value="{{ csrfToken }}" form="addPublisher" />
  <input type="hidden" name="_csrf" value="{{ csrfToken }}" form="removePublisher" />

  <input type="hidden" name="action" value="addPublisher" form="addPublisher" />
  <input type="hidden" name="action" value="removePublisher" form="removePublisher" />

  <div class="govuk-form-group {{ "govuk-form-group--error" if error.field === 'serviceType' }}">
    <fieldset class="govuk-fieldset">
      <legend class="govuk-fieldset__legend govuk-fieldset__legend--m">
        <h3 class="govuk-fieldset__heading govuk-heading-m">
          Service Type?
        </h3>
      </legend>
      {% if error.field === 'serviceType' %}
        <span class="govuk-error-message">
          <span class="govuk-visually-hidden">Error:</span> {{ error.text }}
        </span>
      {% endif %}
      <div class="govuk-radios">
        {% for prop, serviceType in ServiceType %}
          <div class="govuk-radios__item">
            <input
              class="govuk-radios__input"
              form="addPublisher"
              id="serviceType-{{ serviceType }}"
              name="serviceType"
              type="radio"
              value="{{ serviceType }}"
              {{-" checked" if list.type === serviceType }}
              {{-" disabled" if listId !== 'new' }}
            >
            <label class="govuk-label govuk-radios__label" for="serviceType">
              {{ _.startCase(serviceType) }}
            </label>
          </div>
        {% endfor %}
      </div>
    </fieldset>
  </div>

    <div class="govuk-form-group {{ "govuk-form-group--error" if error.field === 'country' }}">
      <h3 class="govuk-label-wrapper">
        <label class="govuk-label govuk-label--m" for="country-autocomplete">
          Which country is this list for?
        </label>
      </h3>
      {% if error.field === 'country' %}
        <span class="govuk-error-message">
          <span class="govuk-visually-hidden">Error:</span> {{ error.text }}
        </span>
      {% endif %}

      {% if listId !== 'new' %}
        <input class="govuk-input" name="country" type="text" value="{{list.country.name}}" form="addPublisher" disabled>
      {% else %}
        <select id="country-autocomplete" name="country" className="govuk-input--error">
          <option value=""></option>
          {% for country in countriesList %}
            <option value="{{ country.value }}" {{-" selected='selected'" if list.country.name === country.value}}>{{ country.text }}</option>
          {% endfor %}
        </select>
      {% endif %}
    </div>

    <hr />

    <div class="govuk-form-group {{ "govuk-form-group--error" if error.field === 'publishers' }}">
      <fieldset class="govuk-fieldset">
        <h3 class="govuk-label-wrapper">
          <label class="govuk-label govuk-label--m" for="publishers">
            Users
          </label>
        </h3>
        {% if error.field === 'publishers' %}
          <span class="govuk-error-message">
            <span class="govuk-visually-hidden">Error:</span> {{ error.text }}
          </span>
        {% endif %}
        <div id="publishers-hint" class="govuk-body">
          All users can accept and publish service providers on the funeral directors list in {{list.country.name}}.
        </div>
        <label class="govuk-label" for="publishers">
          Enter an email address
        </label>
        <input class="govuk-input" id="publishers" name="publishers" type="email" aria-describedby="publishers-hint" form="addPublisher">
      </fieldset>
    </div>

    <button class="govuk-button" data-module="govuk-button" form="addPublisher">
      {% if listId === 'new' %}
        Create
      {% else %}
        Add to list
      {% endif %}
    </button>

      {% if error.field === 'publisherList' %}
        <span class="govuk-error-message">
          <span class="govuk-visually-hidden">Error:</span> {{ error.text }}
        </span>
      {% endif %}
    <dl class="govuk-summary-list {{ "govuk-form-group--error" if error.field === 'publisherList' }}">
      {% for publisher in _.reverse(list.jsonData.publishers) %}
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key">
            {{ publisher }}
          </dt>
          <dd class="govuk-summary-list__actions">
            <button class="govuk-button govuk-button--secondary govuk-!-margin-0" data-module="govuk-button" name="publisherEmail" value="{{ publisher }}" form="removePublisher">
              Remove<span class="govuk-visually-hidden"> publisher</span>
            </button>
          </dd>
        </div>
      {% endfor %}
    </dl>
  </form>

  <script nonce="{{cspNonce}}">
    accessibleAutocomplete.enhanceSelectElement({
      defaultValue: '{{list.country.name}}',
      selectElement: document.querySelector('#country-autocomplete'),
      autoselect: true,
      confirmOnBlur: true
    })
  </script>
{% endblock %}
